language: python

cache:
  - apt
  - pip
python:
  - 2.7
  - 3.4
  - 3.5
  - 3.6
  - 3.7
  - 3.8
  - 3.9-dev
  - pypy
  - pypy3
arch:
  - amd64
  - ppc64le
  - s390x
  - arm64
env:
  - ZMQ=
  - ZMQ=bundled

before_install:
  - |
    # https://travis-ci.community/t/permission-issue-while-building-wheels-for-various-python-packages/7822/7
    sudo chown -Rv $USER:$GROUP ~/.cache/pip/wheels
  - sudo add-apt-repository -y ppa:anton+/dnscrypt
  - sudo apt-get update
  - |
    # install libzmq, libsodium unless zmq=bundled
    if [[ $ZMQ != bundled ]]; then
      sudo apt-get install -y -qq libzmq3-dev libsodium-dev
    fi
  - |
    # install cython unless pypy
    if [[ $TRAVIS_PYTHON_VERSION != pypy* ]]; then
      pip install cython
    fi
  - |
    # build libzmq
    if [[ ! -z "$ZMQ" && $ZMQ != bundled ]]; then
      wget https://github.com/zeromq/$ZMQ/archive/master.zip -O libzmq.zip
      unzip libzmq.zip
      pushd "$ZMQ-master"
      ./autogen.sh
      ./configure --enable-drafts
      make -j
      sudo make install
      sudo ldconfig
      popd
      export ZMQ=/usr/local
      export ZMQ_DRAFT_API=1
    fi
  - pip install -r test-requirements.txt
  - |
    # install pinned tornado
    if [[ "$TORNADO" == "master" ]]; then
      pip install https://github.com/tornadoweb/tornado/archive/master.zip
    elif [[ "$TORNADO" == "none" ]]; then
      pip uninstall -yq tornado
    elif [[ ! -z "$TORNADO" ]]; then
      pip install tornado==${TORNADO}
    fi
  - pip freeze

install:
  - python setup.py build_ext --inplace --zmq=$ZMQ

matrix:
  include:
    - python: 3.6
      env: ZMQ= TORNADO=none
    - python: 3.6
      env: ZMQ= TORNADO=master
    - python: 3.6
      env: ZMQ= TORNADO=4.5.*
    - python: 2.7
      env: ZMQ= TORNADO=4.5.*
    - python: 3.5
      env: ZMQ=libzmq
    - python: 3.4
      env: ZMQ=zeromq4-x
    - python: 3.4
      env: ZMQ=zeromq4-1
    - python: 3.4
      env: ZMQ=zeromq3-x
    - python: 3.3
      dist: trusty
      env: ZMQ=
    - python: nightly
      env: ZMQ=
    - python: nightly
      env: ZMQ=bundled
  exclude:
    - python: pypy
      arch: ppc64le
    - python: pypy3
      arch: ppc64le
    - python: pypy
      arch: s390x
    - python: pypy3
      arch: s390x
    - python: pypy
      arch: arm64
    - python: pypy3
      arch: arm64
  allow_failures:
    - env: ZMQ=libzmq
    - python: nightly

script: travis_retry python setup.py test

deploy:
  provider: pypi
  username: __token__
  password:
    secure: OUCA2YZ0eMjjRRt0YrRTr+3t4VSPDTEXXD8S4/x56WvQb0YW4qRe2mCAiZ4Vz7AjzRARpQcayQgzBooRGNkxhRcIPCu1vdqz0rRw3nB8k2yjOKJztcqWjOGQBuQFigSuHl3aKZBBLYmUQ9NwSak+DKm62QnxzKlxPZwa8AfuAT03Pk60s8Mdo87gVEDjCQVAZbK+tir810dOIvGupzgT7LfoIHNxhyXzxWL/ZWBpZV3297a46Jo+MnITW0O1/eOdTSsJ9HgOCPnLukWT1GHlRyxypXIE7KoBZdc7/U1DLJ0Tqeul7ZRQBFZ0FcE5bQ1S/oaYPBSZTcew+n68ZcENWU93485HtupWB9E/NUffQOm7l944FfhI8Gc0XPnfw6rtCMZ7rw/FpU/Kp79xFrh7kfuSjP1pSNRJZ3On4BU1qjopJspYGdCTxbZQvmVzJPdMpeNDpA4tgRI4kYnhV4rZQQXy+qyTC0Ky0Ah4MfmGTNOmxIQs19Bf/mLDzZUAZ7p+ezlwoBtW0E6NOsrXdBxqVKgegO7vzOpWdIq+D6I31lK/jQ/MEOztEdvZ3siC0tLYYso2rQgD6Rsr658Zb4T4VGhhXnV2uY2YEoCC4vKnx27a8zPJYJF81Ahcq49MfIypSHWIKylG5QWdUEhD3qr/Be8aUt1yOezk+wLHSwTeHsk=
  server: https://test.pypi.org/legacy/
  distributions: "sdist bdist_wheel"
  skip_existing: true
  on:
    branch: proto/issue-1401_wheel_upload_from_travis
    tags: true
    condition: "$ZMQ = bundled"
